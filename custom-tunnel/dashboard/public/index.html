<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸš‡ Custom Tunnel Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      header h1 {
        font-size: 48px;
        margin-bottom: 10px;
      }

      header p {
        font-size: 18px;
        opacity: 0.9;
      }

      .card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .refresh-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #667eea;
        border: none;
        color: white;
        border-radius: 8px;
        padding: 10px 16px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 600;
      }

      .refresh-btn:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .refresh-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .refresh-icon {
        display: inline-block;
        transition: transform 0.3s;
      }

      .refresh-btn:hover .refresh-icon {
        transform: rotate(180deg);
      }

      .refresh-icon.spinning {
        animation: spin 1s linear infinite;
      }

      .card h2 {
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .status.running {
        background: #10b981;
      }

      .status.stopped {
        background: #ef4444;
      }

      .status.unknown {
        background: #6b7280;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .button {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .button-primary {
        background: #667eea;
        color: white;
      }

      .button-success {
        background: #10b981;
        color: white;
      }

      .button-danger {
        background: #ef4444;
        color: white;
      }

      .button-secondary {
        background: #e5e7eb;
        color: #374151;
      }

      .control-panel {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .input-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      input[type="number"] {
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 16px;
        width: 120px;
        -moz-appearance: textfield; /* Firefox */
      }

      input[type="number"]:focus {
        outline: none;
        border-color: #667eea;
      }

      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none; /* Chrome, Safari, Edge */
        margin: 0;
      }

      .tunnel-list {
        display: grid;
        gap: 15px;
        margin-top: 20px;
      }

      .tunnel-item {
        background: #f9fafb;
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
      }

      .tunnel-item:hover {
        border-color: #667eea;
        transform: translateX(5px);
      }

      .tunnel-info {
        flex: 1;
      }

      .tunnel-id {
        font-weight: 600;
        color: #667eea;
        font-size: 18px;
        margin-bottom: 5px;
      }

      .tunnel-url {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 8px;
        word-break: break-all;
      }

      .tunnel-meta {
        font-size: 13px;
        color: #9ca3af;
      }

      .tunnel-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .qr-code {
        max-width: 150px;
        border-radius: 10px;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #9ca3af;
      }

      .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        opacity: 0.3;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        animation: slideIn 0.3s;
        z-index: 1000;
      }

      .notification.success {
        background: #10b981;
      }

      .notification.error {
        background: #ef4444;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        header h1 {
          font-size: 36px;
        }

        .tunnel-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .tunnel-actions {
          width: 100%;
          justify-content: space-between;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸš‡ Custom Tunnel Dashboard</h1>
        <p>ë¡œì»¬ ì„œë²„ë¥¼ ì „ ì„¸ê³„ì™€ ê³µìœ í•˜ì„¸ìš”</p>
      </header>

      <!-- Fly.io ì„œë²„ ìƒíƒœ -->
      <div class="card">
        <button
          class="refresh-btn"
          id="refreshBtn"
          onclick="refreshServerStatus()"
        >
          <span class="refresh-icon" id="refreshIcon">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              ></path>
            </svg>
          </span>
          ìƒˆë¡œê³ ì¹¨
        </button>
        <h2>
          <span class="status" id="serverStatus"></span>
          Fly.io ì„œë²„
        </h2>
        <div class="control-panel">
          <button
            class="button button-success"
            id="startServerBtn"
            onclick="startServer()"
          >
            â–¶ï¸ ì„œë²„ ì‹œì‘
          </button>
          <button
            class="button button-danger"
            id="stopServerBtn"
            onclick="stopServer()"
          >
            â¹ï¸ ì„œë²„ ì¤‘ì§€
          </button>
          <span id="serverStatusText" style="color: #6b7280; margin-left: 10px"
            >í™•ì¸ ì¤‘...</span
          >
        </div>
      </div>

      <!-- í„°ë„ ì‹œì‘ -->
      <div class="card">
        <h2>ğŸš€ ìƒˆ í„°ë„ ì‹œì‘</h2>
        <div class="control-panel">
          <div class="input-group">
            <label for="portInput" style="font-weight: 600; color: #374151"
              >í¬íŠ¸:</label
            >
            <input
              type="number"
              id="portInput"
              placeholder="í¬íŠ¸ ë²ˆí˜¸"
              min="1"
              max="65535"
            />
          </div>
          <div class="input-group">
            <label
              for="httpsToggle"
              style="
                font-weight: 600;
                color: #374151;
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="httpsToggle"
                style="width: 20px; height: 20px; cursor: pointer"
              />
              HTTPS ì‚¬ìš©
            </label>
          </div>
          <button class="button button-primary" onclick="startTunnel()">
            ğŸš‡ í„°ë„ ì‹œì‘
          </button>
        </div>
      </div>

      <!-- í™œì„± í„°ë„ ëª©ë¡ -->
      <div class="card">
        <h2>ğŸ“‹ í™œì„± í„°ë„ (<span id="tunnelCount">0</span>)</h2>
        <div id="tunnelList" class="tunnel-list">
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              ></path>
            </svg>
            <p>ì‹¤í–‰ ì¤‘ì¸ í„°ë„ì´ ì—†ìŠµë‹ˆë‹¤</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      let ws;
      let tunnels = {};
      let flyServerStatus = "unknown";

      // WebSocket ì—°ê²°
      function connectWebSocket() {
        // HTTPSì—ì„œëŠ” wss://, HTTPì—ì„œëŠ” ws:// ì‚¬ìš©
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        ws = new WebSocket(`${protocol}//${window.location.host}`);

        ws.onopen = () => {
          console.log("âœ… WebSocket ì—°ê²°ë¨");
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        };

        ws.onclose = () => {
          console.log("âŒ WebSocket ì—°ê²° ëŠê¹€, ì¬ì—°ê²° ì¤‘...");
          setTimeout(connectWebSocket, 3000);
        };
      }

      // WebSocket ë©”ì‹œì§€ ì²˜ë¦¬
      function handleWebSocketMessage(data) {
        switch (data.type) {
          case "initialState":
            flyServerStatus = data.flyServer;
            updateServerStatus();
            data.tunnels.forEach((tunnel) => {
              tunnels[tunnel.id] = tunnel;
            });
            renderTunnels();
            break;

          case "flyServerStarted":
            flyServerStatus = "running";
            updateServerStatus();
            showNotification("ì„œë²„ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤", "success");
            break;

          case "flyServerStopped":
            flyServerStatus = "stopped";
            updateServerStatus();
            showNotification("ì„œë²„ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤", "success");
            break;

          case "flyServerStatusChanged":
            flyServerStatus = data.status;
            updateServerStatus();
            break;

          case "tunnelStarted":
            tunnels[data.tunnel.id] = data.tunnel;
            renderTunnels();
            showNotification("í„°ë„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤", "success");
            break;

          case "tunnelStopped":
            delete tunnels[data.tunnelId];
            renderTunnels();
            showNotification("í„°ë„ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤", "success");
            break;
        }
      }

      // ì„œë²„ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateServerStatus() {
        const statusEl = document.getElementById("serverStatus");
        const textEl = document.getElementById("serverStatusText");
        const startBtn = document.getElementById("startServerBtn");
        const stopBtn = document.getElementById("stopServerBtn");

        statusEl.className = `status ${flyServerStatus}`;

        if (flyServerStatus === "running") {
          textEl.textContent = "ğŸŸ¢ ì‹¤í–‰ ì¤‘";
          textEl.style.color = "#10b981";
          startBtn.innerHTML = "â–¶ï¸ ì„œë²„ ì‹œì‘";
          startBtn.disabled = true;
          stopBtn.innerHTML = "â¹ï¸ ì„œë²„ ì¤‘ì§€";
          stopBtn.disabled = false;
        } else if (flyServerStatus === "stopped") {
          textEl.textContent = "ğŸ”´ ì¤‘ì§€ë¨";
          textEl.style.color = "#ef4444";
          startBtn.innerHTML = "â–¶ï¸ ì„œë²„ ì‹œì‘";
          startBtn.disabled = false;
          stopBtn.innerHTML = "â¹ï¸ ì„œë²„ ì¤‘ì§€";
          stopBtn.disabled = true;
        } else {
          textEl.textContent = "âšª í™•ì¸ ì¤‘...";
          textEl.style.color = "#6b7280";
          startBtn.innerHTML = "â–¶ï¸ ì„œë²„ ì‹œì‘";
          startBtn.disabled = false;
          stopBtn.innerHTML = "â¹ï¸ ì„œë²„ ì¤‘ì§€";
          stopBtn.disabled = false;
        }
      }

      // ì„œë²„ ì‹œì‘
      async function startServer() {
        const btn = document.getElementById("startServerBtn");
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="loading"></span> ì‹œì‘ ì¤‘...';
        btn.disabled = true;

        try {
          const response = await fetch("/api/fly/start", { method: "POST" });
          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error);
          }

          // ì„±ê³µ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ í‘œì‹œ
          showNotification("âœ… ì„œë²„ ì‹œì‘ ìš”ì²­ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤", "success");
        } catch (error) {
          showNotification("âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨: " + error.message, "error");
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      // ì„œë²„ ì¤‘ì§€
      async function stopServer() {
        const btn = document.getElementById("stopServerBtn");
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="loading"></span> ì¤‘ì§€ ì¤‘...';
        btn.disabled = true;

        try {
          const response = await fetch("/api/fly/stop", { method: "POST" });
          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error);
          }

          // ì„±ê³µ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ í‘œì‹œ
          showNotification("âœ… ì„œë²„ ì¤‘ì§€ ìš”ì²­ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤", "success");
        } catch (error) {
          showNotification("âŒ ì„œë²„ ì¤‘ì§€ ì‹¤íŒ¨: " + error.message, "error");
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      // í„°ë„ ì‹œì‘
      async function startTunnel() {
        const port = document.getElementById("portInput").value;
        const useHttps = document.getElementById("httpsToggle").checked;

        if (!port) {
          showNotification("í¬íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", "error");
          return;
        }

        showNotification("í„°ë„ ì‹œì‘ ì¤‘...", "success");

        try {
          const response = await fetch("/api/tunnel/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              port: parseInt(port),
              useHttps: useHttps,
            }),
          });

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error);
          }
        } catch (error) {
          showNotification("í„°ë„ ì‹œì‘ ì‹¤íŒ¨: " + error.message, "error");
        }
      }

      // í„°ë„ ì¤‘ì§€
      async function stopTunnel(tunnelId) {
        try {
          const response = await fetch(`/api/tunnel/stop/${tunnelId}`, {
            method: "POST",
          });
          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error);
          }
        } catch (error) {
          showNotification("í„°ë„ ì¤‘ì§€ ì‹¤íŒ¨: " + error.message, "error");
        }
      }

      // í„°ë„ ëª©ë¡ ë Œë”ë§
      function renderTunnels() {
        const tunnelList = document.getElementById("tunnelList");
        const tunnelCount = document.getElementById("tunnelCount");
        const tunnelArray = Object.values(tunnels);

        tunnelCount.textContent = tunnelArray.length;

        if (tunnelArray.length === 0) {
          tunnelList.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <p>ì‹¤í–‰ ì¤‘ì¸ í„°ë„ì´ ì—†ìŠµë‹ˆë‹¤</p>
          </div>
        `;
          return;
        }

        tunnelList.innerHTML = tunnelArray
          .map(
            (tunnel) => `
        <div class="tunnel-item">
          <div class="tunnel-info">
            <div class="tunnel-id">ğŸš‡ ${tunnel.id}</div>
            <div class="tunnel-url">${tunnel.url}</div>
            <div class="tunnel-meta">
              í¬íŠ¸: ${tunnel.port} | í”„ë¡œí† ì½œ: ${
              tunnel.useHttps ? "HTTPS ğŸ”’" : "HTTP"
            } | ì‹œì‘: ${new Date(tunnel.startTime).toLocaleTimeString("ko-KR")}
            </div>
          </div>
          <div class="tunnel-actions">
            <img id="qr-${tunnel.id}" class="qr-code" style="display:none;">
            <button class="button button-secondary" onclick="copyUrl('${
              tunnel.url
            }')">
              ğŸ“‹ ë³µì‚¬
            </button>
            <button class="button button-secondary" onclick="showQR('${
              tunnel.id
            }', '${tunnel.url}')">
              ğŸ“± QR
            </button>
            <button class="button button-danger" onclick="stopTunnel('${
              tunnel.id
            }')">
              â¹ï¸ ì¤‘ì§€
            </button>
          </div>
        </div>
      `
          )
          .join("");
      }

      // URL ë³µì‚¬
      function copyUrl(url) {
        navigator.clipboard.writeText(url).then(() => {
          showNotification("URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤", "success");
        });
      }

      // QR ì½”ë“œ í‘œì‹œ
      async function showQR(tunnelId, url) {
        const qrImg = document.getElementById(`qr-${tunnelId}`);

        if (qrImg.style.display === "block") {
          qrImg.style.display = "none";
          return;
        }

        try {
          const response = await fetch(
            `/api/qrcode/${encodeURIComponent(url)}`
          );
          const data = await response.json();

          if (data.success) {
            qrImg.src = data.qrCode;
            qrImg.style.display = "block";
          }
        } catch (error) {
          showNotification("QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨", "error");
        }
      }

      // ì•Œë¦¼ í‘œì‹œ
      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // ì„œë²„ ìƒíƒœ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
      async function refreshServerStatus() {
        const btn = document.getElementById("refreshBtn");
        const icon = document.getElementById("refreshIcon");

        btn.disabled = true;
        icon.classList.add("spinning");

        try {
          const response = await fetch("/api/status");
          const data = await response.json();
          flyServerStatus = data.flyServer;
          updateServerStatus();
          showNotification("ì„œë²„ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤", "success");
        } catch (error) {
          showNotification("ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: " + error.message, "error");
          console.error("ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", error);
        } finally {
          setTimeout(() => {
            icon.classList.remove("spinning");
            btn.disabled = false;
          }, 500);
        }
      }

      // ì´ˆê¸°í™”
      connectWebSocket();

      // ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœ í™•ì¸
      setInterval(async () => {
        try {
          const response = await fetch("/api/status");
          const data = await response.json();
          flyServerStatus = data.flyServer;
          updateServerStatus();
        } catch (error) {
          console.error("ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", error);
        }
      }, 10000);
    </script>
  </body>
</html>
